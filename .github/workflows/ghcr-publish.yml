# SPDX-License-Identifier: AGPL-3.0-or-later
name: Publish to GHCR

permissions: read-all

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    strategy:
      matrix:
        target:
          - name: wharf-cli
            dockerfile-target: wharf-cli
          - name: yacht-agent
            dockerfile-target: yacht-agent

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install nerdctl and containerd
        run: |
          # Install containerd
          sudo apt-get update
          sudo apt-get install -y containerd
          sudo systemctl start containerd

          # Install nerdctl
          NERDCTL_VERSION=2.0.2
          curl -sSL "https://github.com/containerd/nerdctl/releases/download/v${NERDCTL_VERSION}/nerdctl-${NERDCTL_VERSION}-linux-amd64.tar.gz" | sudo tar -xz -C /usr/local/bin

          # Install CNI plugins
          CNI_VERSION=1.6.1
          sudo mkdir -p /opt/cni/bin
          curl -sSL "https://github.com/containernetworking/plugins/releases/download/v${CNI_VERSION}/cni-plugins-linux-amd64-v${CNI_VERSION}.tgz" | sudo tar -xz -C /opt/cni/bin

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo nerdctl login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build image
        run: |
          sudo nerdctl build --target ${{ matrix.target.dockerfile-target }} -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.target.name }}:${{ github.sha }} .
          sudo nerdctl tag ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.target.name }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.target.name }}:latest

      - name: Push image
        run: |
          sudo nerdctl push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.target.name }}:${{ github.sha }}
          sudo nerdctl push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.target.name }}:latest

      - name: Tag release version
        if: github.event_name == 'release'
        run: |
          VERSION=${{ github.event.release.tag_name }}
          sudo nerdctl tag ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.target.name }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.target.name }}:${VERSION}
          sudo nerdctl push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.target.name }}:${VERSION}
