# SPDX-License-Identifier: PMPL-1.0-or-later
# Panic-Attack Security Scan — Universal stress testing + VeriSimDB ingest
name: Security Scan

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

permissions: read-all

jobs:
  panic-attack:
    name: Panic-Attack Assail
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: stable

      - name: Cache panic-attacker binary
        id: cache-pa
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/panic-attacker
          key: panic-attacker-${{ runner.os }}

      - name: Build panic-attacker
        if: steps.cache-pa.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/hyperpolymath/panic-attacker.git /tmp/panic-attacker
          cd /tmp/panic-attacker
          cargo build --release
          cp target/release/panic-attacker ~/.cargo/bin/

      - name: Run panic-attack assail
        run: |
          panic-attacker assail . --output /tmp/scan-results.json
          echo "## Panic-Attack Scan Results" >> $GITHUB_STEP_SUMMARY
          WEAK_POINTS=$(jq '.weak_points | length' /tmp/scan-results.json 2>/dev/null || echo 0)
          echo "- Weak points found: $WEAK_POINTS" >> $GITHUB_STEP_SUMMARY

      - name: Upload scan artifact
        uses: actions/upload-artifact@65c79d7f54e76e4e3c7a8f34db0f4ac8b515c478 # v4
        with:
          name: panic-attack-results
          path: /tmp/scan-results.json
          retention-days: 90

      - name: Ingest to VeriSimDB
        if: always()
        env:
          VERISIMDB_PAT: ${{ secrets.VERISIMDB_PAT }}
        run: |
          if [ -z "$VERISIMDB_PAT" ]; then
            echo "VERISIMDB_PAT not set — skipping VeriSimDB ingest"
            exit 0
          fi

          curl -X POST \
            -H "Authorization: token $VERISIMDB_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/hyperpolymath/verisimdb-data/dispatches \
            -d "{\"event_type\":\"ingest-scan\",\"client_payload\":{\"repo\":\"project-wharf\",\"scan_file\":\"panic-attack-results\"}}"

          echo "Dispatched VeriSimDB ingest event"
