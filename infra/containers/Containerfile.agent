# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2026 Jonathan D.A. Jewell (hyperpolymath) <jonathan.jewell@open.ac.uk>
#
# Yacht Agent Container for Project Wharf
# ========================================
# Minimal runtime — Wolfi-base with glibc for the Rust binary.
#
# Build: podman build -t yacht-agent:latest -f infra/containers/Containerfile.agent .
# Run:   podman run -d -p 3306:3306 -p 9001:9001 yacht-agent:latest

# -----------------------------------------------------------------------------
# Stage 1: Build the Rust binary (glibc)
# -----------------------------------------------------------------------------
FROM cgr.dev/chainguard/wolfi-base:latest AS builder

RUN apk add --no-cache rust pkgconf openssl-dev gcc glibc-dev

WORKDIR /build

# Copy workspace files
COPY Cargo.toml Cargo.lock ./
COPY crates/wharf-core ./crates/wharf-core
COPY bin/yacht-agent ./bin/yacht-agent
COPY bin/wharf-cli ./bin/wharf-cli
# Dummy xtask for workspace resolution
RUN mkdir -p xtask/src && echo 'fn main() {}' > xtask/src/main.rs
COPY xtask/Cargo.toml xtask/Cargo.toml

RUN cargo build --release --bin yacht-agent

# Strip the binary for smaller size
RUN strip target/release/yacht-agent

# -----------------------------------------------------------------------------
# Stage 2: Minimal runtime — Wolfi-base (glibc required)
# -----------------------------------------------------------------------------
FROM cgr.dev/chainguard/wolfi-base:latest

LABEL org.opencontainers.image.title="Yacht Agent"
LABEL org.opencontainers.image.description="Database proxy and security enforcer for Project Wharf"
LABEL org.opencontainers.image.vendor="Hyperpolymath"
LABEL org.opencontainers.image.source="https://gitlab.com/hyperpolymath/wharf"

# Copy the binary
COPY --from=builder /build/target/release/yacht-agent /yacht-agent

# Database proxy port (masquerade as MySQL)
EXPOSE 3306
# Agent API port (health checks, metrics, mooring)
EXPOSE 9001

# Chainguard static runs as nonroot (65532) by default

ENTRYPOINT ["/yacht-agent"]
CMD ["--listen-port", "3306", "--shadow-port", "33060", "--api-port", "9001"]
