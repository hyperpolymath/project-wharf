# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 Jonathan D. A. Jewell <hyperpolymath>
#
# OpenLiteSpeed Virtual Host Configuration for WordPress
# =======================================================
# Hardened WordPress hosting with security headers and caching.

docRoot                   $VH_ROOT

# Index files
index {
    useServer             0
    indexFiles            index.php, index.html
    autoIndex             0
}

# Error pages
errorPage 404 {
    url                   /index.php
}

# -----------------------------------------------------------------------------
# Security Headers
# -----------------------------------------------------------------------------

context / {
    location              $VH_ROOT
    allowBrowse           1

    extraHeaders          <<<END_HEADERS
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' https: data:; frame-ancestors 'self';"
    END_HEADERS

    rewrite {
        enable            1
        inherit           1
        rewriteFile       rewrite.conf
    }
}

# -----------------------------------------------------------------------------
# Block wp-admin Access (The Dark Matter)
# -----------------------------------------------------------------------------
# This is the core of Wharf's security model:
# wp-admin exists on disk but returns 403 to all web requests.
# Administration happens via Wharf offline, not through the web.

context /wp-admin {
    location              $VH_ROOT/wp-admin/
    allowBrowse           0

    rewrite {
        enable            1
        rules             <<<END_RULES
            RewriteRule .* - [F,L]
        END_RULES
    }
}

# Block wp-login.php
context /wp-login.php {
    location              $VH_ROOT/wp-login.php
    allowBrowse           0

    rewrite {
        enable            1
        rules             <<<END_RULES
            RewriteRule .* - [F,L]
        END_RULES
    }
}

# Block xmlrpc.php (common attack vector)
context /xmlrpc.php {
    location              $VH_ROOT/xmlrpc.php
    allowBrowse           0

    rewrite {
        enable            1
        rules             <<<END_RULES
            RewriteRule .* - [F,L]
        END_RULES
    }
}

# -----------------------------------------------------------------------------
# Static File Caching
# -----------------------------------------------------------------------------

context exp:^.*(css|gif|ico|jpeg|jpg|js|png|svg|webp|woff|woff2)$ {
    location              $VH_ROOT
    allowBrowse           1
    enableExpires         1
    expiresByType         image/*=A31536000, text/css=A31536000, application/javascript=A31536000, font/*=A31536000
    extraHeaders          <<<END_HEADERS
        Cache-Control "public, max-age=31536000, immutable"
    END_HEADERS
}

# -----------------------------------------------------------------------------
# PHP Handler (LSAPI - faster than FastCGI)
# -----------------------------------------------------------------------------

scriptHandler {
    add lsapi:wordpress   php
}

extProcessor wordpress {
    type                  lsapi
    address               uds://tmp/lshttpd/lsphp.sock
    maxConns              10
    env                   PHP_LSAPI_MAX_REQUESTS=1000
    env                   PHP_LSAPI_CHILDREN=10
    initTimeout           60
    retryTimeout          0
    persistConn           1
    pcKeepAliveTimeout    60
    respBuffer            0
    autoStart             2
    path                  /usr/local/lsws/lsphp83/bin/lsphp
    backlog               100
    instances             1
    priority              0
    memSoftLimit          2047M
    memHardLimit          2047M
    procSoftLimit         1400
    procHardLimit         1500
}

# -----------------------------------------------------------------------------
# Health Check Endpoint
# -----------------------------------------------------------------------------

context /health {
    location              $VH_ROOT
    allowBrowse           1
    rewrite {
        enable            1
        rules             <<<END_RULES
            RewriteRule .* - [R=200,L]
        END_RULES
    }
}

# -----------------------------------------------------------------------------
# LiteSpeed Cache Configuration
# -----------------------------------------------------------------------------
# If using LiteSpeed Cache plugin, enable this:

module cache {
    enabled               1
    maxCacheObjSize       10000000
    maxStaleAge           200
    qsCache               1
    reqCookieCache        1
    respCookieCache       1
    ignoreReqCacheCtrl    1
    ignoreRespCacheCtrl   0

    storagePath           /dev/shm/lscache/

    enableCache           0
    expireInSeconds       86400
    enablePrivateCache    0
    privateExpireInSeconds 86400
}
