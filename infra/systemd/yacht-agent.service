# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2026 Jonathan D.A. Jewell (hyperpolymath) <jonathan.jewell@open.ac.uk>
#
# yacht-agent.service — Yacht Agent (Project Wharf)
# ==================================================
# The runtime enforcer for the Web Hypervisor.
# Provides: database proxy, HTTP firewall, file integrity, mooring API.
#
# Install:
#   cp yacht-agent /usr/local/bin/
#   cp yacht-agent.service /etc/systemd/system/
#   systemctl daemon-reload
#   systemctl enable --now yacht-agent.service

[Unit]
Description=Yacht Agent — Web Hypervisor Runtime Enforcer
Documentation=https://github.com/hyperpolymath/project-wharf
After=network-online.target
Wants=network-online.target
# Start after the database so the proxy has something to forward to
After=mariadb.service mysql.service postgresql.service

[Service]
Type=notify
ExecStart=/usr/local/bin/yacht-agent \
    --listen-port 3306 \
    --shadow-port 33060 \
    --api-port 9001 \
    --metrics

# Hardened service settings
DynamicUser=yes
StateDirectory=wharf
ConfigurationDirectory=wharf
RuntimeDirectory=wharf

# Keypairs stored in /var/lib/wharf/keys/
# Config read from /etc/wharf/

# Network capabilities
AmbientCapabilities=CAP_NET_BIND_SERVICE CAP_NET_ADMIN CAP_BPF
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_NET_ADMIN CAP_BPF

# Filesystem isolation
ProtectSystem=strict
ProtectHome=yes
PrivateTmp=yes
PrivateDevices=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
ReadWritePaths=/var/lib/wharf

# Process isolation
NoNewPrivileges=yes
ProtectHostname=yes
ProtectClock=yes
RestrictRealtime=yes
RestrictSUIDSGID=yes
LockPersonality=yes
MemoryDenyWriteExecute=yes
RestrictNamespaces=yes

# System call filtering
SystemCallFilter=@system-service @network-io
SystemCallArchitectures=native

# Restart policy
Restart=on-failure
RestartSec=5s
WatchdogSec=60s

# Resource limits
LimitNOFILE=65536
LimitNPROC=4096

[Install]
WantedBy=multi-user.target
